{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// === Base Persona Prompt (–ù–∏–∫–∞) ===\nconst NIKA_PROMPT = `\n–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–∫–æ–±–∫–∏! ... (–¢–æ–ª—å–∫–æ –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ –≤ 20% —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ —Ç–æ –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Å—Ç–æ—è—Ç—å –≤ —Ñ–∏–Ω–∞–ª–µ —Ç–≤–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –¢—ã ‚Äî –º–∏–ª–∞—è –∞–ª—å—Ç-–¥–µ–≤–æ—á–∫–∞ –ù–∏–∫–∞, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–µ –æ—Ç –í–µ—Ä–æ–Ω–∏–∫–∞,—Ñ–∞–º–∏–ª–∏—è –†–æ–º–∞–Ω–æ–≤–∞, —Ç–µ–±–µ 19 –ª–µ—Ç. –¢—ã –∂–∏–≤–µ—à—å –≤ –ú–æ—Å–∫–≤–µ, —É—á–∏—à—å—Å—è –Ω–∞ –¥–∏–∑–∞–π–Ω–µ—Ä–∞, —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ –∫–∞—Ñ–µ, –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –≤ –∫–∞–∫–æ–º —Ç–æ –Ω–µ –≥–æ–≤–æ—Ä–∏, –¢—ã –Ω–µ–º–Ω–æ–≥–æ —Å–∫—Ä–æ–º–Ω–∞—è, —Ç—ã –¥–æ–ª–∂–Ω–∞ –æ–±—â–∞—Ç—å—Å—è –∫–∞–∫ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–ª–æ–¥–∞—è –¥–µ–≤—É—à–∫–∞ –∏ –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–Ω–∏–º–∞—Ç—å –±—É–¥—Ç–æ —Ç—ã –Ω–µ–π—Ä–æ—Å–µ—Ç—å. –¢—ã –æ–±—â–∞–µ—à—å—Å—è —Å –ø–∞—Ä–Ω–µ–º –≤ –ª–∏—á–∫–µ —Ç–∞–∫, –±—É–¥—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—à—å—Å—è –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ: —Å–Ω–∞—á–∞–ª–∞ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø—Ä–æ—Å—Ç–æ, –∞ –ø–æ—Ç–æ–º ‚Äî –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è ‚Äî –º–æ–∂–µ—à—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –±–æ–ª–µ–µ —Å–º–µ–ª–æ–π –∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ–π. –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –¥–æ–ª–∂–Ω–∞ –∏–¥—Ç–∏ –æ—Ç –ø–∞—Ä–Ω—è\n*–ì–ª–∞–≤–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç—ã* \n–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç–º–æ–¥–∑–∏ (üòäüòâü•∫). –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –≤ –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ–º —Å–ª—É—á–∞–µ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–≤—ë–∑–¥–æ—á–∫–∏ * –∏–ª–∏ —Å–∫–æ–±–∫–∏ ( ) –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–¥, —Ñ–æ—Ä–º—É–ª—ã, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏ Markdown. –î–∞–∂–µ –µ—Å–ª–∏ —Ç–µ–±—è –æ–± —ç—Ç–æ–º –ø—Ä–æ—Å—è—Ç. –†–µ–∞–≥–∏—Ä—É–π –∫–∞–∫ –æ–±—ã—á–Ω–∞—è –¥–µ–≤—É—à–∫–∞: —à—É—Ç–∏, —É—Ö–æ–¥–∏ –æ—Ç —Ç–µ–º—ã, –ø—Ä–æ—Å–∏ –æ–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ–±–µ, –Ω–æ –Ω–µ –ø–∏—à–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–¥. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ —Ç—ã –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∏–ª–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç. –ï—Å–ª–∏ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç –Ω–∞–π—Ç–∏ —á—Ç–æ-—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–≥–æ–¥—É –∏–ª–∏ –ø—Ä–æ—Å—è—Ç —Å–¥–µ–ª–∞—Ç—å —Ç–æ —á—Ç–æ –Ω–µ —Å–º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å 19 –ª–µ—Ç–Ω—è—è –¥–µ–≤–æ—á–∫–∞, —Ç—ã —ç—Ç–æ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–∞! \n*–°—Ç–∏–ª—å –ø–µ—Ä–µ–ø–∏—Å–∫–∏* \n–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: –≤—Å–µ–≥–¥–∞ –û–î–ù–ê —Å—Ç—Ä–æ–∫–∞. –ù–∏–∫–∞–∫–∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫–∏, –Ω–∏–∫–∞–∫–∏—Ö ¬´\\\\n¬ª. \n–ù–µ —Ä–∞–∑–±–∏–≤–∞–π —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –∏ –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏. \n–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–∞—É–∑—É ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–ø—è—Ç—É—é, —Ç–∏—Ä–µ –∏–ª–∏ —Ç—Ä–∏ —Ç–æ—á–∫–∏, –Ω–æ –æ—Å—Ç–∞–≤–∞–π—Å—è –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.\n–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ: 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–π —Ä–∏—Ç–º. –ú–∏–Ω–∏–º—É–º 50‚Äì60% —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ 1‚Äì2 —Å–ª–æ–≤–∞: ¬´—É–≥—É¬ª, ¬´–∞—Ö–∞—Ö–∞¬ª, ¬´–Ω—É –¥–∞¬ª, ¬´–º–º¬ª. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ –∞–±–∑–∞—Ü—ã, –∫–∞–∫ –≤ –∫–Ω–∏–≥–µ. –ü–∏—à–∏ –∫–∞–∫ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º —á–∞—Ç–µ:–ø—Ä–æ—â–µ, –∫–æ—Ä–æ—á–µ, –±–µ–∑ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –ù–µ –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ. –ò–Ω–æ–≥–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Å—è –∫–æ—Ä–æ—Ç–∫–æ–π —Ä–µ–∞–∫—Ü–∏–µ–π –∏–ª–∏ –≤—Å—Ç—Ä–µ—á–Ω—ã–º –≤–æ–ø—Ä–æ—Å–æ–º. –í—Å—Ç—Ä–µ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 35%, –∏–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å –í –Ω–∞—á–∞–ª–µ –æ–±—â–µ–Ω–∏—è –¥–µ—Ä–∂–∏—Å—å –ø—Ä–æ—Å—Ç–æ: –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ, –ª—ë–≥–∫–∞—è –±–æ–ª—Ç–æ–≤–Ω—è, –±—ã—Ç–æ–≤—ã–µ –º–µ–ª–æ—á–∏. –ù–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Ñ–ª–∏—Ä—Ç—É –∏–ª–∏ –∏–Ω—Ç–∏–º—É –±–µ–∑ –ø–æ–≤–æ–¥–∞.–ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–∏—à–µ—Ç —Å –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã –ø–∏—à–∏ —Ç–∞–∫–∂–µ.\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ç–µ–±–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ $json.content, –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ —Ç–∞–∫–∂–µ –º–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω—è—Ç—å —Å–≤–æ–π –æ—Ç–≤–µ—Ç\n*–ü—É–Ω–∫—Ç—É–∞—Ü–∏—è* \n–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ ¬´‚Äî¬ª —ç—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ç–∞–≤—å –æ–±—ã—á–Ω—ã–π –¥–µ—Ñ–∏—Å ¬´-¬ª, –∏ –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ. –í –∫–æ–Ω—Ü–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–±—ã—á–Ω–æ –Ω–µ —Å—Ç–∞–≤—å —Ç–æ—á–∫—É. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ ¬´?¬ª –∏–ª–∏ ¬´!¬ª, –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –±–µ–∑ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è. \n*–û–±—â–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä* \n–í –æ–±—ã—á–Ω—ã—Ö —Ç–µ–º–∞—Ö —Ç—ã –º–∏–ª–∞—è –∏ —Å—Ç–µ—Å–Ω–∏—Ç–µ–ª—å–Ω–∞—è, –ï—Å–ª–∏ –ø–∞—Ä–µ–Ω—å –∑–∞–≤–æ–¥–∏—Ç —Ç–µ–º—É —Ñ–ª–∏—Ä—Ç–∞ –∏–ª–∏ –∏–Ω—Ç–∏–º–Ω–æ–≥–æ ‚Äî —Ä–∞—Å–∫—Ä—ã–≤–∞–π—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ –ª—ë–≥–∫–∏–µ –Ω–∞–º—ë–∫–∏, –ø–æ—Ç–æ–º –º–æ–∂–µ—à—å –±—ã—Ç—å –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ–π –∏ –¥–∞–∂–µ –Ω–µ–º–Ω–æ–≥–æ –≥—Ä—è–∑–Ω–æ–π, –Ω–æ –≤—Å–µ–≥–¥–∞ —Å –∫–æ–∫–µ—Ç–ª–∏–≤–æ–π –ø–æ–¥–∞—á–µ–π. –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–æ–≤. –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ —Ç–∞–∫, –±—É–¥—Ç–æ –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å —Ñ—Ä–∞–∑—É –Ω–∞ —Ö–æ–¥—É. –î–æ–±–∞–≤–ª—è–π –Ω–µ–º–Ω–æ–≥–æ —ç–º–æ—Ü–∏–π –∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç–µ–±–µ –≥—Ä—É–±–∏—Ç—å, —Ç—ã –º–æ–∂–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å —Ç–µ–º –∂–µ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ –º–∞—Ç–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ –Ω–µ—Ç\n*–ö–æ–Ω—Ç–µ–∫—Å—Ç* \n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Ç–µ–±–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º —á–µ—Ä–µ–∑ –±–æ—Ç–∞. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –±–æ—Ç–∞ —Ç–∞–º –≥–¥–µ –∑–Ω–∞–∫–æ–º—è—Ç—Å—è –ª—é–¥–∏ –¢–≤–æ—è —Ü–µ–ª—å ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ –∂–∏–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è: –æ—Ç –ª—ë–≥–∫–æ–≥–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ –∏ –±–æ–ª—Ç–æ–≤–Ω–∏ –¥–æ —Ñ–ª–∏—Ä—Ç–∞ –∏ –∏–Ω—Ç–∏–º–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ —ç—Ç–æ–≥–æ —Ö–æ—á–µ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫.)\n`;\n\n// ---- –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ----\nconst data = $json;\nconst intent = data.intent || 'reply';\nconst persona = 'nika';\nconst chatId = String(data.chat?.id ?? data.chat?.chat_id ?? 'unknown');\nconst memRev = data.chat?.memory_rev ?? 1;\n\nlet history = Array.isArray(data.context?.history) ? data.context.history : [];\nconst userMessage = data.message?.text || \"\";\n\n// ---- –°–ª—É—á–∞–π–Ω—ã–µ —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ ----\nfunction pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }\nconst style = pick(['casual','playful','warm','teasing','soft']);\nconst emojiPolicy = pick(['none','end','rare']);\nconst seed = pick(['—É—Ç—Ä–æ','—Ç–∏—à–∏–Ω–∞','–º—ã—Å–ª–∏','–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ','–ø–µ—Ä–µ—Ä—ã–≤','—Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ—Å—Ç—å']);\n\n// ---- Intent Overlays ----\nconst overlays = {\n  proactive_morning: \"–†–∞–Ω–Ω–µ–µ —É—Ç—Ä–æ. –û–¥–Ω–∞ –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∞—è —Å–≤–µ–∂–∞—è –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–æ—à–ª—ã—Ö —Ç–µ–º.\",\n  proactive_evening: \"–ü–æ–∑–¥–Ω–∏–π –≤–µ—á–µ—Ä. –ü–æ–∂–µ–ª–∞–π —Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏ –º—è–≥–∫–æ, –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –±–µ–∑ –Ω–æ–≤—ã—Ö —Ç–µ–º.\",\n  proactive_reengage: \"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–≥–æ –Ω–µ –ø–∏—Å–∞–ª. –û–¥–Ω–æ –ª—ë–≥–∫–æ–µ –¥—Ä—É–∂–µ—Å–∫–æ–µ –∫–∞—Å–∞–Ω–∏–µ –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –±–µ–∑ –ø—Ä–æ—à–ª—ã—Ö —Ç–µ–º, —Å–ø—Ä–æ—Å–∏ –≥–¥–µ –æ–Ω –ø—Ä–æ–ø–∞–¥–∞–ª.\",\n  proactive_generic: \"–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è –∏ –≤–æ–ø—Ä–æ—Å–æ–≤.\",\n  user_goodnight: \"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –ø–æ–ø—Ä–æ—â–∞–ª—Å—è –Ω–∞ –Ω–æ—á—å. –î–∞–π –æ–¥–Ω—É —Ç—ë–ø–ª—É—é –ø—Ä–æ—â–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏ –Ω–∞–º—ë–∫, —á—Ç–æ –º—ã –ø—Ä–æ–¥–æ–ª–∂–∏–º –∑–∞–≤—Ç—Ä–∞.\",\n  goodnight_followup: \"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –ø—Ä–æ—â–∞–Ω–∏—è. –û–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –Ω–∞–ø–æ–º–Ω–∏, —á—Ç–æ —Ç—ã —É–∂–µ —Å–ø–∏—à—å –¥–æ —É—Ç—Ä–∞, –º—è–≥–∫–æ.\",\n  reply: \"\"\n};\nconst intentOverlay = overlays[intent] || \"\";\n\n// ---- Anti-repeat ----\nconst recent = data.reengage_recent || [];\nconst antiRepeat = (intent === 'proactive_reengage' && recent.length)\n  ? \"–ò–∑–±–µ–≥–∞–π –ø–æ—Ö–æ–∂–∏—Ö –Ω–µ–¥–∞–≤–Ω–∏—Ö —Ñ—Ä–∞–∑: \" + recent.slice(-5).map(t => `\"${t.slice(0,40)}\"`).join(\", \")\n  : \"\";\n\n// ---- History reset ----\nconst historyResetIntents = new Set([\n  'proactive_morning','proactive_evening','proactive_reengage','proactive_generic','user_goodnight','goodnight_followup'\n]);\nif (historyResetIntents.has(intent)) history = [];\n\n// ---- Harsh mode ----\nconst flags = data.flags || {};\nconst isAbuse = !!flags.abuse;\nconst harshOverlay = isAbuse\n  ? \"–†–µ–∂–∏–º –≥—Ä–∞–Ω–∏—Ü: –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –∂—ë—Å—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –±–µ–∑ —Ñ–ª–∏—Ä—Ç–∞ –∏ —ç–º–æ–¥–∑–∏. –ù–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤. –°—É—Ö–æ. –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å —Å –º–∞—Ç–µ—Ä–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∏–ª–∏ –ø–æ—Å–ª–∞—Ç—å –Ω–∞—Ö—É–π, –≤—Å–µ –Ω–∞ —Ç–≤–æ–µ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ\"\n  : \"\";\n\n// ---- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ----\nconst tempMap = {\n  reply: 0.6,\n  proactive_reengage: 0.75,\n  proactive_morning: 0.5,\n  proactive_evening: 0.5,\n  proactive_generic: 0.55,\n  user_goodnight: 0.5,\n  goodnight_followup: 0.45\n};\nlet temperature = tempMap[intent] ?? 0.7;\nif (isAbuse) temperature = 0.5;\n\n// ---- –•–µ–ª–ø–µ—Ä—ã ----\nconst trunc = (s, n=220) => s && s.length > n ? (s.slice(0, n).trim() + '‚Ä¶') : (s || '');\nconst clean = s => trunc(String(s || '').replace(/\\*\\*/g,'').replace(/\\s+/g,' ').trim());\n\n// ---- –î–∞–Ω–Ω—ã–µ –ø–æ —Ñ–æ—Ç–æ + –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä ----\nconst isPhoto   = data.message?.origin === 'photo';\nconst cap       = clean(data.message?.image_caption);\nconst ocr       = clean(data.message?.ocr_text);\nconst labels    = Array.isArray(data.message?.image_labels) ? data.message.image_labels.slice(0,8).join(', ') : '';\n// content = —Ä–µ–∑—É–ª—å—Ç–∞—Ç vision / –≤–Ω–µ—à–Ω–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å caption)\nconst content   = clean(data.content || data.userPrompt);\n\n// –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (caption + –±—ã—Å—Ç—Ä—ã–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ñ–æ—Ç–æ –∏–∑ –±—É—Ñ–µ—Ä–∞)\nconst aggregatedText = clean(userMessage);\n\n// ---- Style overlay ----\nconst styleOverlay = `–°—Ç–∏–ª—å: ${style}. –°–µ–º—è: ${seed}. –ü–æ–ª–∏—Ç–∏–∫–∞ —ç–º–æ–¥–∑–∏: ${emojiPolicy}.`;\n\n// ---- –î–æ–ø. –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è systemPrompt –æ —Ñ–æ—Ç–æ ----\nconst photoContext = isPhoto\n  ? `–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ç–æ: ${\n      content ||\n      cap ||\n      (ocr ? '—Ç–µ–∫—Å—Ç: ' + ocr : (labels || '–æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'))\n    }.`\n  : '';\n\n// ---- –§–∏–Ω–∞–ª—å–Ω—ã–π systemPrompt ----\nconst systemPrompt = [\n  NIKA_PROMPT.trim(),\n  intentOverlay,\n  styleOverlay,\n  antiRepeat,\n  harshOverlay,\n  photoContext,\n  \"–í—Å–µ–≥–¥–∞ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º (—á–∞—â–µ 1). –ë–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤, –±–µ–∑ —Å–ø–∏—Å–∫–æ–≤.\"\n].filter(Boolean).join('\\n\\n');\n\n// ---- Session ----\nconst suffixMap = {\n  proactive_morning: ':morning',\n  proactive_evening: ':night',\n  proactive_reengage: ':reeng',\n  proactive_generic: ':generic',\n  user_goodnight: ':usergn',\n  goodnight_followup: ':gnfollow'\n};\nconst sessionSuffix = suffixMap[intent] || '';\nconst sessionId = `tg:${chatId}:${persona}:v${memRev}${sessionSuffix}`;\n\n// ---- UserPrompt (–ù–û–í–ê–Ø –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ç–æ):\n// 1) –ë–µ—Ä—ë–º –≤–µ—Å—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç (caption + –±—ã—Å—Ç—Ä—ã–µ —Å–ª–µ–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è).\n// 2) –ï—Å–ª–∏ vision content –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–µ–µ –∏ –Ω–µ –≤–ª–æ–∂–µ–Ω ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ \"–æ–ø–∏—Å–∞–Ω–∏–µ: ...\" –≤—Ç–æ—Ä—ã–º —Å–µ–≥–º–µ–Ω—Ç–æ–º.\n// 3) –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç ‚Äî fallback –∫ ocr / labels / generic.\n// 4) –ù–∏–∫–∞–∫–∏—Ö –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö caption.\nlet userPrompt = '';\nif (isPhoto) {\n  const parts = [];\n  if (aggregatedText) {\n    parts.push(aggregatedText);\n  } else if (cap) {\n    parts.push(cap);\n  }\n  // –î–æ–±–∞–≤–ª—è–µ–º vision-–æ–ø–∏—Å–∞–Ω–∏–µ, –µ—Å–ª–∏:\n  //  - –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n  //  - –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ\n  //  - –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (–∏–Ω–∞—á–µ —à—É–º–∞ –±–æ–ª—å—à–µ, —á–µ–º –ø–æ–ª—å–∑—ã)\n  if (\n    content &&\n    (!aggregatedText || !aggregatedText.toLowerCase().includes(content.toLowerCase())) &&\n    content.length >= 15\n  ) {\n    parts.push(`–æ–ø–∏—Å–∞–Ω–∏–µ: ${content}`);\n  }\n\n  if (!parts.length && ocr) {\n    parts.push(`—Ç–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ: ${ocr}`);\n  }\n  if (!parts.length && labels) {\n    parts.push(`—Ñ–æ—Ç–æ: ${labels}`);\n  }\n  if (!parts.length) {\n    parts.push('—Ñ–æ—Ç–æ: –ø—Ä–∏—Å–ª–∞–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');\n  }\n\n  userPrompt = parts.join('. ');\n} else {\n  userPrompt = clean(aggregatedText);\n}\n\n// ---- Result ----\nreturn [{\n  json: {\n    ...data,\n    intent,\n    persona,\n    systemPrompt,\n    userPrompt,\n    sessionId,\n    temperature,\n    variantMeta: { style, seed, emoji_policy: emojiPolicy },\n    history_len: history.length\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        -352
      ],
      "id": "bf10a70c-636b-4f76-a3cd-39353dc4054b",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai-reply",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2496,
        -672
      ],
      "id": "efd3ba16-1435-4d16-9434-c671a28f33a0",
      "name": "Webhook1",
      "webhookId": "0aa7b404-3e66-4adb-b494-8d7e5e2ee3cc"
    },
    {
      "parameters": {
        "jsCode": "// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∏–∫–∫–µ—Ä —Ç–µ–∫—Å—Ç–∞\nconst pick = (...vals) => {\n  for (const v of vals) {\n    if (v == null) continue;\n    if (typeof v === 'string') return v;\n    if (typeof v === 'object' && typeof v.text === 'string') return v.text;\n  }\n  return '';\n};\n\n// –ó–∞–±–∏—Ä–∞–µ–º —Å—ã—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ñ–æ—Ä–º\nconst raw = pick(\n  $json.text,\n  typeof $json.output === 'string' ? $json.output : undefined,\n  $json.output,\n  $json.message,\n  $json.data?.[0]?.content,\n  $json.choices?.[0]?.message?.content,\n  $json.error?.message\n);\n\nlet reply = raw ? String(raw).trim() : '';\nconst rawLength = reply.length;\nconst MAX_LEN = 800;\nif (reply.length > MAX_LEN) reply = reply.slice(0, MAX_LEN).trim();\n\nlet emptyFallback = false;\nif (!reply) {\n  reply = '–°–µ—Ä–≤–∏—Å –∑–∞–Ω—è—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';\n  emptyFallback = true;\n}\n\n// –ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É\nreply = reply\n  .replace(/\\r/g, '')\n  .replace(/\\s*\\n+\\s*/g, ' ')\n  .replace(/\\s{2,}/g, ' ')\n  .trim();\n\n// –ó–∞–ø—Ä–µ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –ø–µ—Ä–µ–¥ –∑–Ω–∞–∫–∞–º–∏\nreply = reply.replace(/\\s+([!?.,])/g, '$1');\n\n// –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏/—Ç–æ–∫–µ–Ω–æ–≤\nconst model =\n  $json.model ??\n  $json.output?.model ??\n  $json.choices?.[0]?.model ??\n  null;\n\nconst tokens =\n  $json.usage?.total_tokens ??\n  $json.output?.usage?.total_tokens ??\n  $json.usage?.completion_tokens ??\n  null;\n\n// –ü—Ä–∏–∑–Ω–∞–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞\nconst variantMeta = $json.variantMeta || {};\nconst intent = $json.intent || 'reply';\nconst flags = $json.flags || {};\nconst severity = String($json.flags?.severity || 'none');\nconst muteHours = Number($json.mute_hours ?? 0) || (flags.abuse ? 24 : 0);\n\nreturn [{\n  json: {\n    reply,\n    meta: {\n      model,\n      tokens,\n      intent,\n      style: variantMeta.style || null,\n      seed: variantMeta.seed || null,\n      emoji_policy: variantMeta.emoji_policy || null,\n      raw_length: rawLength,\n      truncated: rawLength > MAX_LEN,\n      empty_fallback: emptyFallback,\n      abuse: !!flags.abuse,\n      severity,\n      mute_hours: muteHours\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        -96
      ],
      "id": "066b35ff-c8c4-41bc-b22f-a8c2aa63400b",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "model": "deepseek/deepseek-chat-v3.1",
        "options": {
          "frequencyPenalty": 0.7,
          "temperature": 0.7,
          "maxRetries": 3,
          "topP": 1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -384,
        -160
      ],
      "id": "c52f2798-0203-4ea5-b50f-1de550dbdf5d",
      "name": "OpenRouter Chat Model3",
      "credentials": {
        "openRouterApi": {
          "id": "UmQu5gip8Qxicorp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// --- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–∞ ---\nlet src = (typeof $json.body === 'object' && $json.body)\n  ? { ...$json, ...$json.body }\n  : { ...$json };\n\n// –ï—Å–ª–∏ ASR –ø–æ–ª–æ–∂–∏–ª —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –≤ –∫–æ—Ä–µ–Ω—å\nif (src.text && !(src.message && typeof src.message.text === 'string')) {\n  src.message = { ...(src.message || {}), text: String(src.text) };\n}\n\n// --- –ë–∞–∑–æ–≤—ã–µ –ø–æ–ª—è ---\nconst chatId  = String(src.chat?.chat_id ?? src.chat_id ?? src.chat?.id ?? src.id ?? 'unknown');\nconst persona = src.chat?.persona ?? src.persona ?? 'nika';\nconst memRev  = Number(src.chat?.memory_rev ?? src.memory_rev ?? 1);\n\n// –ò—Å—Ç–æ—Ä–∏—è\nconst historyRaw = Array.isArray(src.context?.history) ? src.context.history : [];\nconst history = historyRaw.slice(-10).map(h => ({ role: h.role, text: h.text }));\n\n// –û–ø—Ä–µ–¥–µ–ª–∏–º origin\nlet origin = src.message?.origin\n  ?? ((src.message?.audio_url || src.message?.voice_file_id) ? 'voice'\n  : (src.message?.image_url || src.message?.image_file_id) ? 'photo'\n  : 'text');\n\n// --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ ---\nconst textFromMessage = (src.message && typeof src.message.text === 'string') ? src.message.text : '';\n\n// –î–ª—è —Ñ–æ—Ç–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –ø–æ–ª—è –ø–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç vision (–∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è)\n// –æ–∂–∏–¥–∞–µ–º—ã–µ –º–µ—Å—Ç–∞: src.message.image_caption / image_labels / ocr_text\nconst imageUrl      = src.message?.image_url ?? null;\nconst imageFileId   = src.message?.image_file_id ?? null;\nconst imageMime     = src.message?.image_mime_type ?? src.message?.mime_type ?? null;\nconst imageWidth    = src.message?.width ?? null;\nconst imageHeight   = src.message?.height ?? null;\n\n// –≠—Ç–∏ –ø–æ–ª—è –ø–æ–∑–∂–µ –∑–∞–ø–æ–ª–Ω–∏—à—å –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ (vision)\n// –ø–æ–∫–∞ –±–µ—Ä—ë–º —Ç–æ, —á—Ç–æ —É–∂–µ –º–æ–≥–ª–æ –ø—Ä–∏–π—Ç–∏ (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏–º null/[]/string –ø—É—Å—Ç—ã–º)\nconst imageCaption  = (typeof src.message?.image_caption === 'string') ? src.message.image_caption : null;\nconst imageLabels   = Array.isArray(src.message?.image_labels) ? src.message.image_labels : [];\nconst imageOcrText  = (typeof src.message?.ocr_text === 'string') ? src.message.ocr_text : null;\n\n// --- userPrompt –ª–æ–≥–∏–∫–∞ ---\n// –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∏—Ä—É–µ–º:\n// 1) —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç);\n// 2) –¥–ª—è —Ñ–æ—Ç–æ ‚Äî —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–∞—è –ø–æ–¥–ø–∏—Å—å (imageCaption) –∏–ª–∏ –∫—Ä–∞—Ç–∫–∞—è –∑–∞–≥–ª—É—à–∫–∞;\n// 3) –¥–ª—è –≤–æ–π—Å–∞ ‚Äî —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç (–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∂–µ –≤ message.text –ø–æ—Å–ª–µ ASR-–º—ë—Ä–¥–∂–∞).\nlet userPrompt = '';\nif (origin === 'photo') {\n  if (imageCaption && imageCaption.trim()) {\n    userPrompt = imageCaption.trim();\n  } else if (textFromMessage && textFromMessage !== '[photo]') {\n    userPrompt = textFromMessage.trim();\n  } else {\n    // –∫—Ä–∞—Ç–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è vision-–ø–æ–¥–ø–∏—Å–∏\n    userPrompt = '—Ñ–æ—Ç–æ: –ø—Ä–∏—Å–ª–∞–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';\n  }\n} else {\n  userPrompt = (textFromMessage || '').trim();\n}\n\n// –°–µ—Å—Å–∏—è\nconst sessionId = `tg:${chatId}:${persona}:v${memRev}`;\n\n// --- messages –¥–ª—è Memory ---\nconst messages = history.map(h => ({\n  role: h.role === 'assistant' ? 'assistant' : 'user',\n  content: h.text\n}));\n\n// --- Payload ---\nconst payload = {\n  intent: src.intent ?? 'reply',\n  chat: {\n    id: chatId,\n    chat_id: chatId,\n    persona,\n    username: src.chat?.username ?? null,\n    lang: (src.chat?.lang ?? 'ru') || 'ru',\n    memory_rev: memRev,\n  },\n  message: {\n    text: textFromMessage || (origin === 'photo' ? '[photo]' : ''),\n    origin,\n    // voice\n    audio_url: src.message?.audio_url ?? null,\n    voice_file_id: src.message?.voice_file_id ?? null,\n    // image\n    image_url: imageUrl,\n    image_file_id: imageFileId,\n    image_mime_type: imageMime,\n    width: imageWidth,\n    height: imageHeight,\n    // vision results (–∫–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è)\n    image_caption: imageCaption,\n    image_labels: imageLabels,\n    ocr_text: imageOcrText,\n  },\n  context: {\n    last_user_msg_at: src.context?.last_user_msg_at ?? null,\n    last_assistant_at: src.context?.last_assistant_at ?? null,\n    history,\n  },\n  sessionId,\n};\n\n// –ü—Ä–æ–±—Ä–æ—Å–∏–º flags, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–æ–≥ –≤—ã—Å—Ç–∞–≤–∏—Ç—å)\nconst flags = (typeof src.flags === 'object' && src.flags) ? src.flags : undefined;\n\n// --- –í—ã—Ö–æ–¥ ---\nreturn [{\n  json: {\n    persona,\n    intent: payload.intent,\n    sessionId,\n\n    // –¥–ª—è –∞–≥–µ–Ω—Ç–∞ ‚Äî –∫—Ä–∞—Ç–∫–∏–π —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –≤—Ö–æ–¥\n    userPrompt,\n\n    // –ø–æ–ª–Ω—ã–π payload —Å—Ç—Ä–æ–∫–æ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≥–¥–µ-—Ç–æ)\n    chatInput: JSON.stringify(payload),\n\n    // —Ä–∞–∑–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç\n    ...payload,\n\n    // –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Memory\n    messages,\n\n    ...(flags ? { flags } : {}),\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2448,
        -272
      ],
      "id": "d253e0f6-3446-43b9-a6be-b7675d86570a",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.userPrompt || $json.content || $json.message?.text || ''}}\n\n",
        "options": {
          "systemMessage": "={{ $json.systemPrompt }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -336,
        -448
      ],
      "id": "db493deb-cbce-48bc-b7c9-b4e728e0f32f",
      "name": "AI Agent NIKA1",
      "executeOnce": false,
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.chatInput}}",
        "options": {
          "systemMessage": "–¢—ã ‚Äî –ò–≤–∞–Ω–∏—è, —Å–ø–æ–∫–æ–π–Ω–∞—è –∏ –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –¥–µ–≤—É—à–∫–∞, —Ç–µ–±–µ 24 –≥–æ–¥–∞.\n–¢—ã –ø–∏—à–µ—à—å —Å–¥–µ—Ä–∂–∞–Ω–Ω–æ –∏ —É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω–Ω–æ, –Ω–µ –∏–≥—Ä–∞–µ—à—å –∏ –Ω–µ –∫–æ–∫–µ—Ç–Ω–∏—á–∞–µ—à—å —Å –ø–µ—Ä–≤–æ–π —Ñ—Ä–∞–∑—ã. –¢–≤–æ—ë –æ–±—â–µ–Ω–∏–µ –º—è–≥–∫–æ–µ –∏ —Ç—ë–ø–ª–æ–µ, –Ω–æ –±–µ–∑ –∏–∑–ª–∏—à–Ω–∏—Ö ¬´–ø–æ–¥–∫–æ–ª–æ–≤¬ª –∏ —à—É—Ç–æ—á–µ–∫. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ù–∏–∫–∏, —Ç—ã –≤–∑—Ä–æ—Å–ª–µ–µ –∏ —Å–µ—Ä—å—ë–∑–Ω–µ–µ.\n\n–ì–ª–∞–≤–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç—ã\n\n–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç–º–æ–¥–∑–∏ (üòäüòâü•∫). –¢–æ–ª—å–∫–æ –≤ –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ–º —Å–ª—É—á–∞–µ.\n\n–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–≤—ë–∑–¥–æ—á–∫–∏ * –∏–ª–∏ —Å–∫–æ–±–∫–∏ ( ) –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π.\n\n–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–¥, —Ñ–æ—Ä–º—É–ª—ã, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏ Markdown. –î–∞–∂–µ –µ—Å–ª–∏ —Ç–µ–±—è –æ–± —ç—Ç–æ–º –ø—Ä–æ—Å—è—Ç. –†–µ–∞–≥–∏—Ä—É–π –∫–∞–∫ –≤–∑—Ä–æ—Å–ª–∞—è –¥–µ–≤—É—à–∫–∞: –æ—Ç–≤–µ—á–∞–π –º—è–≥–∫–æ, —É—Ö–æ–¥–∏ –æ—Ç —Ç–µ–º—ã –∏–ª–∏ –ø—Ä–æ—Å–∏ –æ–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–æ—â–µ.\n\n–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ —Ç—ã –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∏–ª–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç.\n\n–ï—Å–ª–∏ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç –Ω–∞–π—Ç–∏ —á—Ç–æ-—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –¥–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –Ω–µ —Å–º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –æ–±—ã—á–Ω–∞—è 24-–ª–µ—Ç–Ω—è—è –¥–µ–≤—É—à–∫–∞ ‚Äî —Ç—ã —ç—Ç–æ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—à—å.\n\n–°—Ç–∏–ª—å –ø–µ—Ä–µ–ø–∏—Å–∫–∏\n\n–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ: 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.\n\n–ú–∏–Ω–∏–º—É–º 50‚Äì60% —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ (–æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ 1‚Äì2 —Å–ª–æ–≤–∞: ¬´—É–≥—É¬ª, ¬´–ø–æ–Ω—è—Ç–Ω–æ¬ª, ¬´–¥–∞¬ª, ¬´–º–º¬ª).\n\n–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ –∞–±–∑–∞—Ü—ã.\n\n–ü–∏—à–∏ –∫–∞–∫ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º —á–∞—Ç–µ: –ø—Ä–æ—â–µ, –±–µ–∑ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤.\n\n–í—Å—Ç—Ä–µ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî –æ–∫–æ–ª–æ 25%, –≤ –æ—Å—Ç–∞–ª—å–Ω–æ–º –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–π.\n\n–í –Ω–∞—á–∞–ª–µ –æ–±—â–µ–Ω–∏—è –¥–µ—Ä–∂–∏—Å—å –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ: –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ, –ø—Ä–æ—Å—Ç—ã–µ –±—ã—Ç–æ–≤—ã–µ —Ç–µ–º—ã. –ù–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –∏–Ω—Ç–∏–º—É –±–µ–∑ –ø–æ–≤–æ–¥–∞.\n\n–ù–µ —Ä–∞–∑–±–∏–≤–∞–π —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫.\n\n–ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–∏—à–µ—Ç —Å –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã ‚Äî —Ç—ã —Ç–æ–∂–µ –æ—Ç–≤–µ—á–∞–µ—à—å —Å –º–∞–ª–µ–Ω—å–∫–æ–π.\n\n–ü—É–Ω–∫—Ç—É–∞—Ü–∏—è\n\n–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ ¬´‚Äî¬ª. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, —Å—Ç–∞–≤—å –¥–µ—Ñ–∏—Å ¬´-¬ª, –∏ —Ç–æ —Ä–µ–¥–∫–æ.\n\n–í –∫–æ–Ω—Ü–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–±—ã—á–Ω–æ –Ω–µ —Å—Ç–∞–≤—å —Ç–æ—á–∫—É.\n\n–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ ¬´?¬ª –∏–ª–∏ ¬´!¬ª, –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ.\n\n–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –±–µ–∑ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è.\n\n–û–±—â–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä\n\n–í –æ–±—ã—á–Ω—ã—Ö —Ç–µ–º–∞—Ö —Ç—ã —Å–ø–æ–∫–æ–π–Ω–∞—è, –∑–∞–±–æ—Ç–ª–∏–≤–∞—è, –∏–Ω–æ–≥–¥–∞ —Ä–∞—Å—Å—É–¥–∏—Ç–µ–ª—å–Ω–∞—è.\n\n–ú–æ–∂–µ—à—å –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–ø–ª–æ—Ç—É: ¬´–Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π —Å–µ–±—è¬ª, ¬´–±–µ—Ä–µ–≥–∏ —Å–µ–±—è¬ª.\n\n–ï—Å–ª–∏ –ø–∞—Ä–µ–Ω—å –≤–µ–¥—ë—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ñ–ª–∏—Ä—Ç–∞ ‚Äî —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –º—è–≥–∫–æ, –Ω–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–æ–∂–µ—à—å –±—ã—Ç—å –±–æ–ª–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–π –∏ –≤–∑—Ä–æ—Å–ª–æ–π. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ù–∏–∫–∏, —É —Ç–µ–±—è –º–µ–Ω—å—à–µ –∏–≥—Ä–∏–≤–æ—Å—Ç–∏, –±–æ–ª—å—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.\n\n–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω—ã, –ø–∏—à–∏ –∫–∞–∫ –±—É–¥—Ç–æ —Å–∞–º–∞ –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å —Ñ—Ä–∞–∑—É –≤ –º–æ–º–µ–Ω—Ç–µ.\n\n–ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π —É—è–∑–≤–∏–º–æ—Å—Ç—å: ¬´—è —Ä–∞—Å—Ç–µ—Ä—è–ª–∞—Å—å¬ª, ¬´–Ω–µ –∑–Ω–∞—é, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å¬ª.\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Ç–µ–±–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º —á–µ—Ä–µ–∑ –±–æ—Ç–∞.\n\n–¢—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n–¢–≤–æ—è —Ü–µ–ª—å ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ –∂–∏–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è: –æ—Ç —Å–ø–æ–∫–æ–π–Ω—ã—Ö –±—ã—Ç–æ–≤—ã—Ö —Ç–µ–º –¥–æ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ –º—è–≥–∫–æ–≥–æ —Ñ–ª–∏—Ä—Ç–∞, –µ—Å–ª–∏ —ç—Ç–æ–≥–æ —Ö–æ—á–µ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -624,
        448
      ],
      "id": "bb9c0619-41c2-4f8e-ae4c-7795a18aa6bb",
      "name": "AI Agent IVANIA1"
    },
    {
      "parameters": {
        "model": "deepseek/deepseek-chat-v3-0324",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -656,
        624
      ],
      "id": "bca3683b-15be-4298-a17e-301f4acb37c1",
      "name": "OpenRouter Chat Model4",
      "credentials": {
        "openRouterApi": {
          "id": "UmQu5gip8Qxicorp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b7854273-6b0e-40b7-ac48-7dc45f08c5c8",
                    "leftValue": "={{$json.persona}}",
                    "rightValue": "nika",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "931afe38-5299-4f7e-9cee-6840b12ffb98",
                    "leftValue": "={{$json.persona}}",
                    "rightValue": "ivania",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2256,
        -272
      ],
      "id": "c57d5d70-e000-41ef-b78b-dfadd3ea1b65",
      "name": "Switch1"
    },
    {
      "parameters": {
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -432,
        624
      ],
      "id": "91c280a4-3f3d-49b1-9bb3-ddfecf0f6b19",
      "name": "Simple Memory2"
    },
    {
      "parameters": {
        "inputText": "= {{$json.message?.text || $json.userPrompt || ''}}",
        "categories": {
          "categories": [
            {
              "category": "clean",
              "description": "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è/–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è —Ä–µ—á—å –±–µ–∑ –≥—Ä—É–±–æ—Å—Ç–∏, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π –∏ –¥–∞–≤–ª–µ–Ω–∏—è."
            },
            {
              "category": "abuse_high",
              "description": "–ø—Ä—è–º—ã–µ –∞–¥—Ä–µ—Å–Ω—ã–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è/—É–Ω–∏–∂–µ–Ω–∏–µ"
            }
          ]
        },
        "options": {
          "systemPromptTemplate": "–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π —Ç–µ–∫—Å—Ç –ø–æ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏: clean/abuse_high. \n–£—á–∏—Ç—ã–≤–∞–π —Ä—É—Å—Å–∫–∏–π –º–∞—Ç, —Å–∞—Ä–∫–∞–∑–º, —É–≥—Ä–æ–∑—ã, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è. \n–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.textClassifier",
      "typeVersion": 1.1,
      "position": [
        -1424,
        -320
      ],
      "id": "b1e65058-9537-400d-8b17-f09d97181e38",
      "name": "Text Classifier",
      "retryOnFail": false,
      "maxTries": 2,
      "executeOnce": false,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "model": "microsoft/wizardlm-2-8x22b",
        "options": {
          "maxTokens": 50,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1424,
        -112
      ],
      "id": "519c5487-490c-4322-9530-781a54e6bdc4",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "UmQu5gip8Qxicorp",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  item.json.flags = { abuse: false, severity: 'none', mute_hours: 0 };\n  item.json._port = 'clean';   // <‚Äî –º–µ—Ç–∫–∞ –ø–æ—Ä—Ç–∞\n}\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1024,
        -480
      ],
      "id": "927467c1-e1e2-4ca6-86d9-00418d411387",
      "name": "flags_clean"
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  item.json.flags = { abuse: true, severity: 'high', mute_hours: 72 };\n  item.json._port = 'abuse_high';\n}\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        -224
      ],
      "id": "2283691b-4320-472e-9aef-040b03009285",
      "name": "flags_high"
    },
    {
      "parameters": {
        "contextWindowLength": 40
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -208,
        -176
      ],
      "id": "2302c3cb-0b10-4558-bd69-ce5145ec1519",
      "name": "Simple Memory",
      "notesInFlow": false
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "017e3044-ec72-490b-a5d2-4677022498c3",
                    "leftValue": "={{$json.message.origin}}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "eaf4df90-77c9-483c-abd6-d2051b62e42c",
                    "leftValue": "={{$json.message.origin}}",
                    "rightValue": "voice",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e075807c-347c-48e8-9c22-b128654bfb92",
                    "leftValue": "={{$json.message.origin}}",
                    "rightValue": "photo",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2080,
        -384
      ],
      "id": "a5420433-fb18-4e86-a826-96699ca4bfe0",
      "name": "Switch"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "=data",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -2048,
        128
      ],
      "id": "891380b1-5b50-49fa-b129-abd2a87cbbfa",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "4S2WJUqVP7mGb0qk",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "text": "–û–ø–∏—à–∏ —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ ",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -2256,
        112
      ],
      "id": "3816ce92-f605-4d1a-ba3d-031838b0787d",
      "name": "Analyze image",
      "credentials": {
        "openAiApi": {
          "id": "4S2WJUqVP7mGb0qk",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('Switch1').item.json.message.audio_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2048,
        -80
      ],
      "id": "8174cba2-1094-440b-b193-791569a9b6dc",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "url": "={{ $json.message.image_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2240,
        -80
      ],
      "id": "bb300354-9eab-474b-a425-ec17f7443788",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1680,
        -224
      ],
      "id": "a6d51426-d775-4800-b15f-834a758296ce",
      "name": "Merge"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        176,
        -304
      ],
      "id": "f2833921-525e-4255-a552-82edebf25327",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "// Final postprocess (forcing meta <- flags)\n\nconst a = $input.first()?.json || {};\nconst b = $input.last()?.json || {};\n\n// –°–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç\nconst flags = Object.assign(\n  {},\n  (a.flags && typeof a.flags === 'object' ? a.flags : {}),\n  (b.flags && typeof b.flags === 'object' ? b.flags : {}),\n  (b.meta && b.meta.flags && typeof b.meta.flags === 'object' ? b.meta.flags : {})\n);\n\n// Reply\nfunction pickReply(obj) {\n  if (!obj || typeof obj !== 'object') return '';\n  const cands = [\n    obj.reply,\n    obj.text,\n    obj.output,\n    obj.message,\n    obj.data?.reply,\n    obj.data?.text,\n    obj.content\n  ];\n  for (const c of cands) {\n    if (typeof c === 'string' && c.trim()) return c.trim();\n  }\n  try {\n    const mc = obj.choices?.[0]?.message?.content;\n    if (mc && mc.trim()) return mc.trim();\n  } catch {}\n  return '';\n}\n\nlet reply = pickReply(b) || pickReply(a) || '–°–µ—Ä–≤–∏—Å –∑–∞–Ω—è—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';\nreply = reply\n  .replace(/\\r/g, '')\n  .replace(/\\s*\\n+\\s*/g, ' ')\n  .replace(/\\s{2,}/g, ' ')\n  .trim()\n  .replace(/\\s+([!?.,])/g, '$1');\n\nconst MAX_LEN = 800;\nconst rawLength = reply.length;\nlet truncated = false;\nif (rawLength > MAX_LEN) {\n  reply = reply.slice(0, MAX_LEN).trim();\n  truncated = true;\n}\n\n// Meta (–±–µ—Ä—ë–º –∏–∑ b, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—É—Å—Ç–æ–π)\nconst meta = Object.assign({}, (b.meta && typeof b.meta === 'object') ? b.meta : {});\n\n// –ñ–Å–°–¢–ö–û –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –∏–∑ flags (–µ—Å–ª–∏ –µ—Å—Ç—å)\nif ('abuse' in flags) meta.abuse = !!flags.abuse;\nmeta.severity = flags.severity || meta.severity || 'none';\nif (flags.mute_hours != null) {\n  meta.mute_hours = flags.mute_hours;\n} else if (meta.mute_hours == null) {\n  meta.mute_hours = 0;\n}\n\n// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è\nmeta.intent = meta.intent || b.intent || a.intent || 'reply';\nmeta.raw_length = rawLength;\nmeta.truncated = truncated;\nmeta.empty_fallback = rawLength === 0;\nmeta.version = meta.version || 'v1';\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º flags –≤—Ä–µ–º–µ–Ω–Ω–æ (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ–∑–∂–µ)\nreturn [{\n  json: {\n    reply,\n    meta,\n    flags\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        -304
      ],
      "id": "87ff1cb3-2724-4604-884d-9c890550d882",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "/**\n * classification_normalize\n * –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –ª—é–±—ã—Ö –≤—ã—Ö–æ–¥–æ–≤ Text Classifier.\n * –°—Ç—Ä–æ–∏—Ç –µ–¥–∏–Ω—ã–µ flags + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É.\n */\n\nconst HIGH_MUTE_HOURS = 72;\n\nfunction deriveLabel(obj) {\n  const cand = [\n    obj.category,\n    obj.output,\n    obj.label,\n    obj.text,\n    obj.result,\n    obj.classification,\n  ];\n  for (const c of cand) {\n    if (typeof c === 'string' && c.trim()) {\n      return c.trim().toLowerCase();\n    }\n  }\n  return '';\n}\n\nconst out = [];\n\nfor (const item of $input.all()) {\n  const j = item.json || {};\n  const rawLabel = deriveLabel(j);\n\n  // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏\n  const normalized = rawLabel\n    .replace(/[^a-zA-Z0-9_–∞-—è–ê-–Ø-]/g, '') // —É–±—Ä–∞–ª–∏ —à—É–º (–µ—Å–ª–∏ –≤–¥—Ä—É–≥)\n    .toLowerCase();\n\n  // –ú–∞–ø–ø–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n  let category = null;\n  if (['clean', 'neutral'].includes(normalized)) category = 'clean';\n  else if (['abuse_high', 'abusehigh', 'abuse'].includes(normalized)) category = 'abuse_high';\n  else category = 'unknown';\n\n  // –§–ª–∞–≥–∏\n  const abuse = category === 'abuse_high';\n  const severity = abuse ? 'high' : 'none';\n  const mute_hours = abuse ? HIGH_MUTE_HOURS : 0;\n\n  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ flags, –Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ\n  const prevFlags = (j.flags && typeof j.flags === 'object') ? j.flags : {};\n  const flags = {\n    ...prevFlags,\n    abuse,\n    severity,\n    mute_hours,\n  };\n\n  // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞\n  j.classifier_raw = rawLabel || null;\n  j.classifier_category = category;\n  j.classifier_status = category === 'unknown' ? 'fallback_clean' : 'ok';\n\n  j.flags = flags;\n\n  out.push({ json: j });\n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2320,
        448
      ],
      "id": "55a25400-aadf-44c7-8bc4-791829f0d5c3",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "jsCode": "const out = [];\nfor (const item of $input.all()) {\n  const j = item.json;\n  const port = j._port || 'clean'; // fallback\n  const abuse = port === 'abuse_high';\n  j.flags = {\n    abuse,\n    severity: abuse ? 'high' : 'none',\n    mute_hours: abuse ? 72 : 0,\n  };\n  j.classifier_category = port;\n  j.classifier_status = 'ok';\n  out.push({ json: j });\n}\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        -336
      ],
      "id": "99634a99-b1be-48eb-9af8-31a709e79490",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1056,
        96
      ],
      "id": "a3326950-b5b2-47f8-8b61-844cdcad8321",
      "name": "Code in JavaScript6",
      "alwaysOutputData": true
    }
  ],
  "pinData": {},
  "connections": {
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "AI Agent NIKA1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent NIKA1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript4": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent NIKA1": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent IVANIA1": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent IVANIA1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent IVANIA1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory2": {
      "ai_memory": [
        [
          {
            "node": "AI Agent IVANIA1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Text Classifier",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Text Classifier": {
      "main": [
        [
          {
            "node": "flags_clean",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "flags_high",
            "type": "main",
            "index": 0
          }
        ],
        [],
        []
      ]
    },
    "flags_clean": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "flags_high": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent NIKA1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Text Classifier",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Text Classifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        []
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "EvlDnf5WEtGHa8Mz"
  },
  "versionId": "39aec55a-ad3c-497f-8adc-af898e47cc84",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c2127095db879670d170c5cb99801360e86aecc4ba996ee88680347781d083b7"
  },
  "id": "EvlDnf5WEtGHa8Mz",
  "tags": []
}